with siste_satsperioder as (
  select
    SISTE.SAKSNUMMER 
    ,SISTE.PROGRAMDELTAKELSE_FOM
    ,SISTE.PROGRAMDELTAKELSE_TOM
    ,SISTE.PROGRAMDELTAKELSE_TOM_NY 
    ,SISTE.FK_UP_FAGSAK 
    ,SISTE.BEHANDLINGSPERIODER_TOM_MAX
    ,SISTE.STAT_AARMND 
    ,SISTE.STAT_AARMND_DT
    ,SISTE.ANTALL_DAGER
    ,SISTE.UTBET_FOM
    ,SISTE.UTBET_TOM
    ,SISTE.DATO
    ,SISTE.SISTE_DATO_I_PERIODEN
    ,SISTE.UTFALL
    ,SISTE.YTELSE_TYPE

    ,SATSPERIODER.ANTALL_BARN
    ,SATSPERIODER.FOM SATSPERIODE_FOM -- Husk alias videre!
    ,SATSPERIODER.TOM SATSPERIODE_TOM
    ,SATSPERIODER.dagsats_barnetillegg
    ,SATSPERIODER.DAGSATS_UTEN_BARNETILLEGG
    ,SATSPERIODER.SATS_TYPE

    
    from      {{ ref ('int_up_join_behandlingsperioder') }} SISTE
    left join {{ source ('fam_ungdom', 'fam_up_satsperioder') }} SATSPERIODER
    ON SISTE.FK_UP_FAGSAK = SATSPERIODER.FK_UP_FAGSAK -- Byttet fra PK til FK?
    AND SATSPERIODER.FOM>=SISTE.PROGRAMDELTAKELSE_FOM 
    --SATSPERIODER.TOM<=PROGRAMDELTAKELSE_TOM_NY
    AND SATSPERIODER.FOM<=SISTE.DATO 
    AND SATSPERIODER.TOM>=SISTE.DATO
)

select *
from siste_satsperioder

/*
    LEFT OUTER JOIN FAM_UP_SATSPERIODER SATSPERIODER ON
    SISTE.PK_UP_FAGSAK = SATSPERIODER.FK_UP_FAGSAK AND
    SATSPERIODER.FOM>=PROGRAMDELTAKELSE_FOM 
    --SATSPERIODER.TOM<=PROGRAMDELTAKELSE_TOM_NY
    AND SATSPERIODER.FOM<=DIM_TID_DAG.DATO 
    AND SATSPERIODER.TOM>=DIM_TID_DAG.DATO
*/