with siste_tilkjent as (
  select
    SISTE.SAKSNUMMER 
    ,SISTE.PROGRAMDELTAKELSE_FOM
    ,SISTE.PROGRAMDELTAKELSE_TOM
    ,SISTE.PROGRAMDELTAKELSE_TOM_NY 
    ,SISTE.FK_UP_FAGSAK 
    ,SISTE.BEHANDLINGSPERIODER_TOM_MAX
    ,SISTE.STAT_AARMND 
    ,SISTE.STAT_AARMND_DT
    ,SISTE.ANTALL_DAGER
    ,SISTE.UTBET_FOM
    ,SISTE.UTBET_TOM
    ,SISTE.DATO
    ,SISTE.SISTE_DATO_I_PERIODEN
    ,SISTE.UTFALL
    ,SISTE.ANTALL_BARN
    ,SISTE.SATSPERIODE_FOM
    ,SISTE.SATSPERIODE_TOM
    ,SISTE.dagsats_barnetillegg
    ,SISTE.DAGSATS_UTEN_BARNETILLEGG
    ,SISTE.FK_PERSON1_MOTTAKER
    ,SISTE.VEDTAKSTIDSPUNKT
    ,SISTE.SATS_TYPE
    ,SISTE.YTELSE_TYPE

    --,SUM(NVL(TILKJENT.DAGSATS,TILKJENT_SISTE_PERIODE.DAGSATS)) BELOP
    --,NVL(TILKJENT.DAGSATS,TILKJENT_SISTE_PERIODE.DAGSATS) DAGSATS
    ,TILKJENT.DAGSATS DAGSATS_TEMP -- Henter kun dagsats, har ikke tilgang til TILKJENT_SISTE_PERIODE enda
    ,CASE WHEN TILKJENT.FK_UP_FAGSAK >0 THEN 'A' ELSE 'B' END BUDSJETT
    ,TILKJENT.REDUKSJON
    
    from      {{ ref ('int_up_join_fagsak') }} SISTE
    left join {{ source ('fam_ungdom', 'fam_up_tilkjent_ytelseperioder') }} TILKJENT
    ON SISTE.FK_UP_FAGSAK = TILKJENT.FK_UP_FAGSAK -- Byttet fra PK til FK?
    AND SISTE.DATO>=TILKJENT.FOM 
    AND SISTE.DATO<=TILKJENT.TOM
)

select *
from siste_tilkjent

/*
    LEFT OUTER JOIN  FAM_UP_TILKJENT_YTELSEPERIODER TILKJENT ON
    SISTE.PK_UP_FAGSAK = TILKJENT.FK_UP_FAGSAK AND
    DIM_TID_DAG.DATO>=TILKJENT.FOM AND
    DIM_TID_DAG.DATO<=TILKJENT.TOM
*/