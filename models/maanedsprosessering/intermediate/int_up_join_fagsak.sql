with siste_fagsak as (
  select
    SISTE.SAKSNUMMER 
    ,SISTE.PROGRAMDELTAKELSE_FOM
    ,SISTE.PROGRAMDELTAKELSE_TOM
    ,SISTE.PROGRAMDELTAKELSE_TOM_NY 
    ,SISTE.FK_UP_FAGSAK 
    ,SISTE.BEHANDLINGSPERIODER_TOM_MAX
    ,SISTE.STAT_AARMND 
    ,SISTE.STAT_AARMND_DT
    ,SISTE.ANTALL_DAGER
    ,SISTE.UTBET_FOM
    ,SISTE.UTBET_TOM
    ,SISTE.DATO
    ,SISTE.SISTE_DATO_I_PERIODEN
    ,SISTE.UTFALL
    ,SISTE.ANTALL_BARN
    ,SISTE.SATSPERIODE_FOM
    ,SISTE.SATSPERIODE_TOM
    ,SISTE.dagsats_barnetillegg
    ,SISTE.DAGSATS_UTEN_BARNETILLEGG
    ,SISTE.SATS_TYPE
    ,SISTE.YTELSE_TYPE

    ,FAGSAK.FK_PERSON1 FK_PERSON1_MOTTAKER -- Husk alias videre!
    ,MAX(FAGSAK.VEDTAKSTIDSPUNKT) VEDTAKSTIDSPUNKT
    
    from {{ ref ('int_up_join_satsperioder') }} SISTE
    join {{ source ('fam_ungdom', 'fam_up_fagsak') }} FAGSAK
    ON FAGSAK.PK_UP_FAGSAK=SISTE.FK_UP_FAGSAK -- Byttet fra PK til FK?

    GROUP BY
      SISTE.SAKSNUMMER 
      ,SISTE.PROGRAMDELTAKELSE_FOM
      ,SISTE.PROGRAMDELTAKELSE_TOM
      ,SISTE.PROGRAMDELTAKELSE_TOM_NY 
      ,SISTE.FK_UP_FAGSAK 
      ,SISTE.BEHANDLINGSPERIODER_TOM_MAX
      ,SISTE.STAT_AARMND 
      ,SISTE.STAT_AARMND_DT
      ,SISTE.ANTALL_DAGER
      ,SISTE.UTBET_FOM
      ,SISTE.UTBET_TOM
      ,SISTE.DATO
      ,SISTE.SISTE_DATO_I_PERIODEN
      ,SISTE.UTFALL
      ,SISTE.ANTALL_BARN
      ,SISTE.SATSPERIODE_FOM
      ,SISTE.SATSPERIODE_TOM
      ,SISTE.dagsats_barnetillegg
      ,SISTE.DAGSATS_UTEN_BARNETILLEGG
      ,SISTE.SATS_TYPE
      ,SISTE.YTELSE_TYPE
      ,FAGSAK.FK_PERSON1
)

select *
from siste_fagsak

/*
    JOIN DVH_FAM_UNGDOM.FAM_UP_FAGSAK FAGSAK ON
    FAGSAK.PK_UP_FAGSAK=SISTE.PK_UP_FAGSAK
*/