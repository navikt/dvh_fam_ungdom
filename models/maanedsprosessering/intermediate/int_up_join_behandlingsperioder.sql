{{ 
  config(materialized='view') 
}}

with siste_behandlingsperioder as (
  select
    SISTE.SAKSNUMMER 
    ,SISTE.PROGRAMDELTAKELSE_FOM
    ,SISTE.PROGRAMDELTAKELSE_TOM
    ,SISTE.PROGRAMDELTAKELSE_TOM_NY 
    ,SISTE.FK_UP_FAGSAK 
    ,SISTE.BEHANDLINGSPERIODER_TOM_MAX
    ,SISTE.STAT_AARMND 
    ,SISTE.STAT_AARMND_DT
    ,SISTE.ANTALL_DAGER
    ,SISTE.UTBET_FOM
    ,SISTE.UTBET_TOM
    ,SISTE.DATO
    ,SISTE.SISTE_DATO_I_PERIODEN

    ,BEHANDLINGSPERIODER.UTFALL
    
    from      {{ ref ('int_up_join_dim_tid_mnd') }} SISTE
    left join {{ source ('fam_ungdom', 'fam_up_behandlingsperioder') }} BEHANDLINGSPERIODER
    ON SISTE.FK_UP_FAGSAK = BEHANDLINGSPERIODER.FK_UP_FAGSAK -- Byttet fra PK til FK?
    AND BEHANDLINGSPERIODER.FOM>=SISTE.PROGRAMDELTAKELSE_FOM 
    AND BEHANDLINGSPERIODER.FOM<=SISTE.DATO 
    AND (BEHANDLINGSPERIODER.TOM>=SISTE.DATO)
)

select *
from siste_behandlingsperioder

/*
    LEFT OUTER JOIN FAM_UP_BEHANDLINGSPERIODER BEHANDLINGSPERIODER ON
    SISTE.PK_UP_FAGSAK = BEHANDLINGSPERIODER.FK_UP_FAGSAK AND
    BEHANDLINGSPERIODER.FOM>=PROGRAMDELTAKELSE_FOM 
    --SATSPERIODER.TOM<=PROGRAMDELTAKELSE_TOM_NY
    AND BEHANDLINGSPERIODER.FOM<=DIM_TID_DAG.DATO 
    AND (BEHANDLINGSPERIODER.TOM>=DIM_TID_DAG.DATO )
*/