with siste_tilkjent_siste_periode as (
  select
    SISTE.SAKSNUMMER 
    ,SISTE.PROGRAMDELTAKELSE_FOM
    ,SISTE.PROGRAMDELTAKELSE_TOM
    ,SISTE.PROGRAMDELTAKELSE_TOM_NY 
    ,SISTE.FK_UP_FAGSAK 
    ,SISTE.BEHANDLINGSPERIODER_TOM_MAX
    ,SISTE.STAT_AARMND 
    ,SISTE.STAT_AARMND_DT
    ,SISTE.ANTALL_DAGER
    ,SISTE.UTBET_FOM
    ,SISTE.UTBET_TOM
    ,SISTE.DATO
    ,SISTE.SISTE_DATO_I_PERIODEN
    ,SISTE.UTFALL
    ,SISTE.ANTALL_BARN
    ,SISTE.SATSPERIODE_FOM
    ,SISTE.SATSPERIODE_TOM
    ,SISTE.dagsats_barnetillegg
    ,SISTE.DAGSATS_UTEN_BARNETILLEGG
    ,SISTE.FK_PERSON1_MOTTAKER
    ,SISTE.VEDTAKSTIDSPUNKT
    ,SISTE.DAGSATS_TEMP
    ,SISTE.BUDSJETT
    ,SISTE.REDUKSJON
    ,SISTE.SATS_TYPE
    ,SISTE.YTELSE_TYPE

    ,SUM(NVL(SISTE.DAGSATS_TEMP,TILKJENT_SISTE_PERIODE.DAGSATS)) BELOP -- TILKJENT.DAGSATS = SISTE.DAGSATS_TEMP
    ,NVL(SISTE.DAGSATS_TEMP,TILKJENT_SISTE_PERIODE.DAGSATS) DAGSATS
    
    from      {{ ref ('int_up_join_tilkjent') }} SISTE
    left join {{ ref ('stg_up_tilkjent_ytelseperioder_siste_periode') }} TILKJENT_SISTE_PERIODE
    ON TILKJENT_SISTE_PERIODE.FK_UP_FAGSAK=SISTE.FK_UP_FAGSAK -- Byttet fra PK til FK?

    GROUP BY
        SISTE.SAKSNUMMER 
        ,SISTE.PROGRAMDELTAKELSE_FOM
        ,SISTE.PROGRAMDELTAKELSE_TOM
        ,SISTE.PROGRAMDELTAKELSE_TOM_NY 
        ,SISTE.FK_UP_FAGSAK 
        ,SISTE.BEHANDLINGSPERIODER_TOM_MAX
        ,SISTE.STAT_AARMND 
        ,SISTE.STAT_AARMND_DT
        ,SISTE.ANTALL_DAGER
        ,SISTE.UTBET_FOM
        ,SISTE.UTBET_TOM
        ,SISTE.DATO
        ,SISTE.SISTE_DATO_I_PERIODEN
        ,SISTE.UTFALL
        ,SISTE.ANTALL_BARN
        ,SISTE.SATSPERIODE_FOM
        ,SISTE.SATSPERIODE_TOM
        ,SISTE.dagsats_barnetillegg
        ,SISTE.DAGSATS_UTEN_BARNETILLEGG
        ,SISTE.FK_PERSON1_MOTTAKER
        ,SISTE.VEDTAKSTIDSPUNKT
        ,SISTE.DAGSATS_TEMP
        ,SISTE.BUDSJETT
        ,SISTE.REDUKSJON
        ,SISTE.SATS_TYPE
        ,SISTE.YTELSE_TYPE
        ,NVL(SISTE.DAGSATS_TEMP,TILKJENT_SISTE_PERIODE.DAGSATS)
)

select *
from siste_tilkjent_siste_periode

/*
    LEFT OUTER JOIN  DVH_FAM_UNGDOM.vTILKJENT_YTELSEPERIODER_SISTE_PERIODE  TILKJENT_SISTE_PERIODE ON
    TILKJENT_SISTE_PERIODE.FK_UP_FAGSAK=SISTE.PK_UP_FAGSAK
*/