{{ 
  config(materialized='view') 
}}

with siste_person as (
  select
    SISTE.SAKSNUMMER 
    ,SISTE.PROGRAMDELTAKELSE_FOM
    ,SISTE.PROGRAMDELTAKELSE_TOM
    ,SISTE.PROGRAMDELTAKELSE_TOM_NY 
    ,SISTE.FK_UP_FAGSAK 
    ,SISTE.BEHANDLINGSPERIODER_TOM_MAX
    ,SISTE.STAT_AARMND 
    ,SISTE.STAT_AARMND_DT
    ,SISTE.ANTALL_DAGER
    ,SISTE.UTBET_FOM
    ,SISTE.UTBET_TOM
    ,SISTE.DATO
    ,SISTE.SISTE_DATO_I_PERIODEN
    ,SISTE.UTFALL
    ,SISTE.ANTALL_BARN
    ,SISTE.SATSPERIODE_FOM
    ,SISTE.SATSPERIODE_TOM
    ,SISTE.dagsats_barnetillegg
    ,SISTE.DAGSATS_UTEN_BARNETILLEGG
    ,SISTE.FK_PERSON1_MOTTAKER
    ,SISTE.VEDTAKSTIDSPUNKT
    ,SISTE.DAGSATS_TEMP
    ,SISTE.BUDSJETT
    ,SISTE.REDUKSJON
    ,SISTE.BELOP
    ,SISTE.DAGSATS
  
    ,PERSON.PK_DIM_PERSON FK_DIM_PERSON_MOTTAKER
    ,PERSON.FK_DIM_GEOGRAFI_BOSTED
    ,PERSON.BOSTED_KOMMUNE_NR
    ,PERSON.BOSTED_LAND
    ,FLOOR(MONTHS_BETWEEN(SISTE.SISTE_DATO_I_PERIODEN, PERSON.fodt_dato) / 12.0) Alder

    from      {{ ref ('int_up_join_tilkjent_siste_periode') }} SISTE
    left join {{ source ('dt_person_arena', 'dim_person') }} PERSON
    ON PERSON.FK_PERSON1 = SISTE.FK_PERSON1_MOTTAKER -- FAGSAK.FK_PERSON1 FK_PERSON1_MOTTAKER = SISTE.FK_PERSON1_MOTTAKER
    AND PERSON.GYLDIG_FRA_DATO <= SISTE.SISTE_DATO_I_PERIODEN 
    AND PERSON.GYLDIG_TIL_DATO >= SISTE.SISTE_DATO_I_PERIODEN
)

select *
from siste_person

/*
    LEFT OUTER JOIN DT_PERSON.DIM_PERSON PERSON ON
    PERSON.FK_PERSON1 = FAGSAK.FK_PERSON1 AND
    PERSON.GYLDIG_FRA_DATO <= DIM_TID_MND.SISTE_DATO_I_PERIODEN AND
    PERSON.GYLDIG_TIL_DATO >= DIM_TID_MND.SISTE_DATO_I_PERIODEN
*/