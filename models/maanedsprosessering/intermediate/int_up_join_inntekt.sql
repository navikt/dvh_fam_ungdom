{{ 
  config(materialized='view') 
}}

with siste_inntekt as (
  select
    SISTE.SAKSNUMMER 
    ,SISTE.PROGRAMDELTAKELSE_FOM
    ,SISTE.PROGRAMDELTAKELSE_TOM
    ,SISTE.PROGRAMDELTAKELSE_TOM_NY 
    ,SISTE.FK_UP_FAGSAK 
    ,SISTE.BEHANDLINGSPERIODER_TOM_MAX
    ,SISTE.STAT_AARMND 
    ,SISTE.STAT_AARMND_DT
    ,SISTE.ANTALL_DAGER
    ,SISTE.UTBET_FOM
    ,SISTE.UTBET_TOM
    ,SISTE.DATO
    ,SISTE.SISTE_DATO_I_PERIODEN
    ,SISTE.UTFALL
    ,SISTE.ANTALL_BARN
    ,SISTE.SATSPERIODE_FOM
    ,SISTE.SATSPERIODE_TOM
    ,SISTE.dagsats_barnetillegg
    ,SISTE.DAGSATS_UTEN_BARNETILLEGG
    ,SISTE.FK_PERSON1_MOTTAKER
    ,SISTE.VEDTAKSTIDSPUNKT
    ,SISTE.DAGSATS_TEMP
    ,SISTE.BUDSJETT
    ,SISTE.REDUKSJON
    ,SISTE.BELOP
    ,SISTE.DAGSATS
    ,SISTE.FK_DIM_PERSON_MOTTAKER
    ,SISTE.FK_DIM_GEOGRAFI_BOSTED
    ,SISTE.BOSTED_KOMMUNE_NR
    ,SISTE.BOSTED_LAND
    ,SISTE.Alder
    ,SISTE.FYLKE_NR
    ,SISTE.FYLKE_NAVN

    ,MAX(INNTEKT.INNTEKT) INNTEKT

    from      {{ ref ('int_up_join_dim_geografi_bosted') }} SISTE
    left join {{ source ('fam_ungdom', 'fam_up_inntektperioder') }} INNTEKT
    ON SISTE.FK_UP_FAGSAK = INNTEKT.FK_UP_FAGSAK -- Byttet fra PK til FK?
    AND INNTEKT.FOM<=SISTE.DATO 
    AND INNTEKT.TOM>=SISTE.DATO    

    GROUP BY
        SISTE.SAKSNUMMER 
        ,SISTE.PROGRAMDELTAKELSE_FOM
        ,SISTE.PROGRAMDELTAKELSE_TOM
        ,SISTE.PROGRAMDELTAKELSE_TOM_NY 
        ,SISTE.FK_UP_FAGSAK 
        ,SISTE.BEHANDLINGSPERIODER_TOM_MAX
        ,SISTE.STAT_AARMND 
        ,SISTE.STAT_AARMND_DT
        ,SISTE.ANTALL_DAGER
        ,SISTE.UTBET_FOM
        ,SISTE.UTBET_TOM
        ,SISTE.DATO
        ,SISTE.SISTE_DATO_I_PERIODEN
        ,SISTE.UTFALL
        ,SISTE.ANTALL_BARN
        ,SISTE.SATSPERIODE_FOM
        ,SISTE.SATSPERIODE_TOM
        ,SISTE.dagsats_barnetillegg
        ,SISTE.DAGSATS_UTEN_BARNETILLEGG
        ,SISTE.FK_PERSON1_MOTTAKER
        ,SISTE.VEDTAKSTIDSPUNKT
        ,SISTE.DAGSATS_TEMP
        ,SISTE.BUDSJETT
        ,SISTE.REDUKSJON
        ,SISTE.BELOP
        ,SISTE.DAGSATS
        ,SISTE.FK_DIM_PERSON_MOTTAKER
        ,SISTE.FK_DIM_GEOGRAFI_BOSTED
        ,SISTE.BOSTED_KOMMUNE_NR
        ,SISTE.BOSTED_LAND
        ,SISTE.Alder
        ,SISTE.FYLKE_NR
        ,SISTE.FYLKE_NAVN
)

select *
from siste_inntekt

/*
    LEFT OUTER JOIN DVH_FAM_UNGDOM.FAM_UP_INNTEKTPERIODER INNTEKT ON
    SISTE.PK_UP_FAGSAK = INNTEKT.FK_UP_FAGSAK AND
    INNTEKT.FOM<=DIM_TID_DAG.DATO 
    AND INNTEKT.TOM>=DIM_TID_DAG.DATO    
*/